#!/system/bin/sh
# Adaptive Performance - Add Game Package (with duplicate check)

API_PORT=9877
MODULE_DIR="/data/adb/modules/adaptive_performance"
GAMES_FILE="$MODULE_DIR/game_packages.txt"
APP_GOV_FILE="$MODULE_DIR/app_governors.txt"
PKG="$1"

[ -z "$PKG" ] && {
    echo "‚ùå Usage: adaptperf-add <package>"
    echo "Example: adaptperf-add com.garena.game.df"
    exit 1
}

echo "üîç Checking for duplicates..."

# VALIDATION #1: Check if already in game list
if [ -f "$GAMES_FILE" ]; then
    if grep -qx "$PKG" "$GAMES_FILE"; then
        echo "‚ùå ERROR: Package already exists in game list!"
        echo "Package: $PKG"
        exit 1
    fi
fi

# VALIDATION #2: Check if in per-app governor list
if [ -f "$APP_GOV_FILE" ]; then
    if grep -q "^$PKG:" "$APP_GOV_FILE"; then
        echo "‚ùå ERROR: Package exists in per-app governor list!"
        echo "Package: $PKG"
        echo "Remove from per-app list first."
        exit 1
    fi
fi

echo "‚úÖ Validation passed"
echo "‚ûï Adding game package: $PKG"

PKG_ENCODED=$(echo "$PKG" | sed 's/\./%2E/g')

RESPONSE=$(echo "" | nc 127.0.0.1 $API_PORT << EOF
GET /?action=add&pkg=$PKG_ENCODED HTTP/1.1
Host: 127.0.0.1
Connection: close

EOF
)

if echo "$RESPONSE" | grep -q '"status":"success"'; then
    echo "‚úÖ Package added successfully"
else
    echo "‚ùå Failed to add package"
    echo "$RESPONSE" | grep -o '{.*}'
fi
